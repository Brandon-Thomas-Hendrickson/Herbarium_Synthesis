#!/bin/bash
# =============================================================================
# 06_bam_qc_summary.sh
# Aggregate per-sample bamtools and qualimap statistics (generated by step 02)
# into two combined CSV files for easy downstream inspection.
#
# Requires: step 02 completed (bamtools .txt and qualimap output directories
#           exist in $ALIGNDIR)
#
# Outputs:
#   $QCDIR/bamstats_summary.csv    – bamtools read statistics per sample
#   $QCDIR/qualimap_summary.csv    – qualimap coverage/quality per sample
# =============================================================================

set -euo pipefail
source "$(dirname "$0")/config.sh"

mkdir -p "$QCDIR"

# ---------------------------------------------------------------------------
# 1. Aggregate bamtools stats
# ---------------------------------------------------------------------------
BAMSTATS_CSV="$QCDIR/bamstats_summary.csv"
echo "Sample,Total reads,Mapped reads,Forward strand,Reverse strand,\
Failed QC,Duplicates,Paired-end reads,Proper-pairs,Both pairs mapped,\
Read 1,Read 2,Singletons" > "$BAMSTATS_CSV"

for SAMPLE in $(cat "$SAMPLE_LIST"); do
    STATS_FILE="$ALIGNDIR/${SAMPLE}_bamstats.txt"

    if [[ ! -f "$STATS_FILE" ]]; then
        echo "  WARNING: $STATS_FILE not found – re-running bamtools stats..."
        bamtools stats -in "$ALIGNDIR/${SAMPLE}_marked.bam" > "$STATS_FILE"
    fi

    STATS=$(cat "$STATS_FILE")
    TOTAL_READS=$(echo "$STATS"      | grep "Total reads"       | awk '{print $3}')
    MAPPED_READS=$(echo "$STATS"     | grep "Mapped reads"      | awk '{print $3}')
    FORWARD_STRAND=$(echo "$STATS"   | grep "Forward strand"    | awk '{print $3}')
    REVERSE_STRAND=$(echo "$STATS"   | grep "Reverse strand"    | awk '{print $3}')
    FAILED_QC=$(echo "$STATS"        | grep "Failed QC"         | awk '{print $3}')
    DUPLICATES=$(echo "$STATS"       | grep "Duplicates"        | awk '{print $2}')
    PAIRED_END=$(echo "$STATS"       | grep "Paired-end reads"  | awk '{print $3}')
    PROPER_PAIRS=$(echo "$STATS"     | grep "Proper-pairs"      | awk '{print $2}')
    BOTH_MAPPED=$(echo "$STATS"      | grep "Both pairs mapped" | awk '{print $4}')
    READ_1=$(echo "$STATS"           | grep "Read 1"            | awk '{print $3}')
    READ_2=$(echo "$STATS"           | grep "Read 2"            | awk '{print $3}')
    SINGLETONS=$(echo "$STATS"       | grep "Singletons"        | awk '{print $2}')

    echo "$SAMPLE,$TOTAL_READS,$MAPPED_READS,$FORWARD_STRAND,$REVERSE_STRAND,\
$FAILED_QC,$DUPLICATES,$PAIRED_END,$PROPER_PAIRS,$BOTH_MAPPED,\
$READ_1,$READ_2,$SINGLETONS" >> "$BAMSTATS_CSV"
done

echo "bamtools summary written to $BAMSTATS_CSV"

# ---------------------------------------------------------------------------
# 2. Aggregate qualimap stats
# ---------------------------------------------------------------------------
QUALIMAP_CSV="$QCDIR/qualimap_summary.csv"
echo "Sample,number of reads,number of mapped reads,\
number of supplementary alignments,number of secondary alignments,\
number of duplicated reads,duplication rate,mean mapping quality,\
GC percentage,general error rate,mean coverageData,std coverageData" \
    > "$QUALIMAP_CSV"

for SAMPLE in $(cat "$SAMPLE_LIST"); do
    QUALIMAP_OUTDIR="$ALIGNDIR/${SAMPLE}_qualimap"
    GENOME_RESULTS="$QUALIMAP_OUTDIR/genome_results.txt"

    if [[ ! -f "$GENOME_RESULTS" ]]; then
        echo "  WARNING: $GENOME_RESULTS not found – re-running qualimap..."
        qualimap bamqc \
            -bam "$ALIGNDIR/${SAMPLE}_marked.bam" \
            -outdir "$QUALIMAP_OUTDIR" \
            -outfile "${SAMPLE}_qualimap_report.txt" \
            -outformat TXT
    fi

    # Remove commas from numbers (e.g. "1,234" → "1234") and parse fields
    TOTAL_READS=$(grep "number of reads"                    "$GENOME_RESULTS" | awk '{print $NF}' | sed 's/,//g')
    MAPPED_READS=$(grep "number of mapped reads"            "$GENOME_RESULTS" | awk '{print $NF}' | sed 's/,//g')
    SUPPL_ALIGN=$(grep "number of supplementary alignments" "$GENOME_RESULTS" | awk '{print $NF}' | sed 's/,//g')
    SEC_ALIGN=$(grep "number of secondary alignments"       "$GENOME_RESULTS" | awk '{print $NF}' | sed 's/,//g')
    DUP_READS=$(grep "number of duplicated reads"           "$GENOME_RESULTS" | awk '{print $NF}' | sed 's/,//g')
    DUP_RATE=$(grep "duplication rate"                      "$GENOME_RESULTS" | awk '{print $NF}' | sed 's/,//g')
    MEAN_MQ=$(grep "mean mapping quality"                   "$GENOME_RESULTS" | awk '{print $NF}' | sed 's/,//g')
    GC_PCT=$(grep "GC percentage"                           "$GENOME_RESULTS" | awk '{print $NF}' | sed 's/,//g')
    ERR_RATE=$(grep "general error rate"                    "$GENOME_RESULTS" | awk '{print $NF}' | sed 's/,//g')
    MEAN_COV=$(grep "mean coverageData"                     "$GENOME_RESULTS" | awk '{print $NF}' | sed 's/,//g')
    STD_COV=$(grep "std coverageData"                       "$GENOME_RESULTS" | awk '{print $NF}' | sed 's/,//g')

    echo "$SAMPLE,$TOTAL_READS,$MAPPED_READS,$SUPPL_ALIGN,$SEC_ALIGN,\
$DUP_READS,$DUP_RATE,$MEAN_MQ,$GC_PCT,$ERR_RATE,$MEAN_COV,$STD_COV" \
        >> "$QUALIMAP_CSV"
done

echo "qualimap summary written to $QUALIMAP_CSV"
echo "Done."
